services:
  beszel-agent:
    image: "{{ beszel_agent_image }}:latest"

    environment:
      LOG_LEVEL: "info" # debug, info, warn, error
      LISTEN: "45876"
      KEY: "{{ services_beszel_key }}"
      TOKEN: "{{ services_beszel_token }}"
      HUB_URL: "https://beszel.{{ services_domain_base }}"
      DOCKER_HOST: "tcp://localhost:2375"

    volumes:
      - "{{ services_path.beszel.agent }}:/var/lib/beszel-agent"
      - "/var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket:ro"
      # - "/var/run/systemd/private:/var/run/systemd/private:ro"
      - "/etc/localtime:/etc/localtime:ro"
{% if inventory_hostname == "homeserver_main" %}
      - "/mnt/ssd1/.beszel:/extra-filesystems/sdc1__ssd1:ro"
      - "/mnt/hdd1/.beszel:/extra-filesystems/sda1__hdd1:ro"
      - "/mnt/hdd2/.beszel:/extra-filesystems/sdb1__hdd2:ro"

    devices:
      - "/dev/dri/card1:/dev/dri/card1"
      - "/dev/sda:/dev/sda"
      - "/dev/sdb:/dev/sdb"
      - "/dev/sdc:/dev/sdc"
      - "/dev/sdd:/dev/sdd"

    security_opt:
      - apparmor:unconfined
{% endif %}

    cap_add:
      - "CAP_PERFMON"
      - "SYS_RAWIO"
      - "SYS_ADMIN"

    container_name: "beszel-agent"
    hostname: "beszel-agent"
    restart: "unless-stopped"

    network_mode: "host"
