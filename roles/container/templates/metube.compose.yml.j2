services:
  metube:
    image: "ghcr.io/alexta69/metube:latest"

    labels:
      traefik.enable: true
      traefik.http.routers.metube.rule: Host(`metube.{{ container_domain_base }}`)
      traefik.http.services.metube.loadbalancer.server.port: "8081"
      traefik.http.routers.metube.middlewares: "authelia@docker, sablier@file"

      sablier.enable: true
      sablier.group: "default"
      traefik.docker.allownonrunning: true

      dev.dozzle.group: "Media"

    environment:
      PUID: "{{ container_puid }}"
      PGID: "{{ container_pgid }}"
      TZ: "{{ container_tz }}"
      LOGLEBEL: "INFO" # INFO, DEBUG
      MAX_CONCURRENT_DOWNLOADS: "8"
      TEMP_DIR: "/tmp"
      DOWNLOAD_DIR: "/video"
      AUDIO_DOWNLOAD_DIR: "/audio"
      OUTPUT_TEMPLATE: "%(title)s.%(ext)s"
      OUTPUT_TEMPLATE_CHAPTER: "%(title)s/%(title)s - %(section_number)s - %(section_title)s.%(ext)s"
      OUTPUT_TEMPLATE_PLAYLIST: "%(title)s.%(ext)s"

    volumes:
      - "{{ container_path.metube }}/video:/video"
      - "{{ container_path.metube }}/audio:/audio"

    tmpfs:
      - "/tmp"

    healthcheck:
      test: ["CMD", "wget", "-q", "--tries=1", "--spider", "http://127.0.0.1:8081"]
      interval: "300s"
      timeout: "30s"
      retries: "3"
      start_period: "60s"
      start_interval: "2s"

    container_name: "metube"
    hostname: "metube"
    restart: "unless-stopped"

    networks:
      - "traefik"

networks:
  traefik:
    external: true
    name: "traefik"
