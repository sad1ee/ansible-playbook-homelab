services:
  beszel-agent:
    image: henrygd/beszel-agent:latest

    labels:
      dev.dozzle.group: Backend

    environment:
      LOG_LEVEL: info # debug, info, warn, error
      DOCKER_HOST: tcp://localhost:2375
      LISTEN: "45876"
      HUB_URL: https://beszel.{{ container_domain_base }}
      KEY: "{{ container_beszel_key }}"
      TOKEN: "{{ container_beszel_token }}"
      DISK_USAGE_CACHE: 24h

    volumes:
      - "{{ container_path.beszel_agent }}:/var/lib/beszel-agent"
      - /var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket:ro
      - /etc/localtime:/etc/localtime:ro
      # NOTE: Use ansible facts for device names
      - /mnt/ssd1/.beszel:/extra-filesystems/nvme0n1p1__ssd1:ro
      - /mnt/hdd1/.beszel:/extra-filesystems/sdc1__hdd1:ro
      - /mnt/hdd2/.beszel:/extra-filesystems/sdd1__hdd2:ro
      - /mnt/parity1/.beszel:/extra-filesystems/sdb1__parity1:ro

    security_opt:
      - apparmor:unconfined

    cap_add:
      - CAP_PERFMON
      - SYS_RAWIO
      - SYS_ADMIN

    healthcheck:
      test: [ CMD, /agent, health ]
      interval: 300s
      timeout: 30s
      retries: "3"
      start_period: 60s
      start_interval: 2s

    container_name: beszel-agent
    hostname: beszel-agent
    restart: unless-stopped

    network_mode: host
