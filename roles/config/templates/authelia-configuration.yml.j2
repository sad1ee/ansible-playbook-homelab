---
theme: "auto"

log:
  level: "info" # info, debug, trace

authentication_backend:
  password_change:
    disable: true
  password_reset:
    disable: true
    custom_url: ""
  refresh_interval: "1m"
  ldap:
    implementation: "lldap"
    address: "ldap://lldap:3890"
    base_dn: "DC={{ config_domain_base_seperate.sld }},DC={{ config_domain_base_seperate.tld }}"
    user: "UID=authelia_bind_user,OU=people,DC={{ config_domain_base_seperate.sld }},DC={{ config_domain_base_seperate.tld }}"
    password: "{{ config_authelia_lldap_user_pass }}"

access_control:
  default_policy: "deny"
  rules:
    - domain: "paperless.{{ config_domain_base }}"
      policy: "bypass"
      resources:
      - "^/api([/?].*)?$"
      - "^/static/frontend/en-US/manifest.webmanifest$"
    - domain: "beszel.{{ config_domain_base }}"
      policy: "bypass"
      resources:
      - "^/api([/?].*)?$"
    - domain: "jellyfin.{{ config_domain_base }}"
      policy: "bypass"
    # - domain: "ntfy.{{ config_domain_base }}"
    #   policy: "bypass"
    #   resources:
    #   - "^/manifest.webmanifest$"
    #   - "^/beszel([/?].*)?$"
    #   - "^/wud([/?].*)?$"
    - domain:
        - "jellyfin.{{ config_domain_base }}"
        - "jellyseer.{{ config_domain_base }}"
        # - "cwa.{{ config_domain_base }}"
        - "shelfmark.{{ config_domain_base }}"
        # - "paperless.{{ config_domain_base }}"
      policy: "one_factor"
      subject: ["group:application_user"]
    - domain: "*.{{ config_domain_base }}"
      policy: "one_factor"
      subject: ["group:application_admin"]

session:
  secret: "{{ config_authelia_session_secret }}"
  inactivity: "5m"
  expiration: "1d"
  remember_me: "3M"
  redis:
    host: "redis"
    port: 6379
    database_index: 1
  cookies:
    - domain: "{{ config_domain_base }}"
      authelia_url: "https://authelia.{{ config_domain_base }}"
      default_redirection_url: "https://homepage.{{ config_domain_base }}"

regulation:
  modes:
  - "ip"

storage:
  encryption_key: "{{ config_authelia_storage_key }}"
  postgres:
    address: "tcp://postgres:5432"
    database: "authelia"
    username: "authelia"
    password: "{{ config_authelia_db_pass }}"

notifier:
  disable_startup_check: false
  filesystem:
    filename: "/config/notification.txt"

server:
  endpoints:
    authz:
      forward-auth:
        implementation: "ForwardAuth"
      legacy:
        implementation: "Legacy"

identity_providers:
  oidc:
    hmac_secret: "{{ config_authelia_hmac_secret }}"
    jwks:
      - algorithm: "RS256"
        use: "sig"
        key: |
          {{ config_authelia_jwks_rs256 | trim | indent(10) }}
    authorization_policies:
      allow-all:
        default_policy: "deny"
        rules:
          - policy: "one_factor"
            subject: "group:application_user"
          - policy: "one_factor"
            subject: "group:application_admin"
      allow-admin:
        default_policy: "deny"
        rules:
          - policy: "one_factor"
            subject: "group:application_admin"
    clients:
      - client_id : "beszel"
        client_name: "Beszel"
        client_secret: "{{ config_authelia_client_secret_beszel }}"
        authorization_policy: "allow-admin"
        redirect_uris:
          - "https://beszel.{{ config_domain_base }}/api/oauth2-redirect"
        pre_configured_consent_duration: 3M
        require_pkce: true
        pkce_challenge_method: "S256"

      - client_id : "paperless"
        client_name: "Paperless"
        client_secret: "{{ config_authelia_client_secret_paperless }}"
        authorization_policy: "allow-all"
        redirect_uris:
          - "https://paperless.{{ config_domain_base }}/accounts/oidc/authelia/login/callback/"
        pre_configured_consent_duration: 3M
        require_pkce: true
        pkce_challenge_method: "S256"

      - client_id: "cwa"
        client_name: "CWA"
        client_secret: "{{ config_authelia_client_secret_cwa }}"
        authorization_policy: "allow-all"
        redirect_uris:
          - "https://cwa.{{ config_domain_base }}/login/generic/authorized"
        pre_configured_consent_duration: "3M"
        require_pkce: false
        pkce_challenge_method: ""

      - client_id: "audiobookshelf"
        client_name: "Audiobookshelf"
        client_secret: "{{ config_authelia_client_secret_audiobookshelf }}"
        authorization_policy: "allow-all"
        redirect_uris:
          - "https://audiobookshelf.{{ config_domain_base }}/auth/openid/callback"
          - "https://audiobookshelf.{{ config_domain_base }}/auth/openid/mobile-redirect"
          - "audiobookshelf://oauth"
        pre_configured_consent_duration: "3M"
        require_pkce: true
        pkce_challenge_method: "S256"

      # NOTE: Postponed until jellyseer implements oidc
      # - client_id: "jellyfin"
      #   client_name: "Jellyfin"
      #   client_secret: "{{ config_authelia_client_secret_jellyfin }}"
      #   authorization_policy: "allow-all"
      #   pre_configured_consent_duration: "3M"
      #   require_pkce: true
      #   pkce_challenge_method: "S256"
      #   redirect_uris:
      #     - "https://jellyfin.{{ config_domain_base }}/sso/OID/redirect/authelia"
      #   token_endpoint_auth_method: "client_secret_post"

      # NOTE: Does not work, keeps timouting when registering component oidc
      # - client_id: "wud"
      #   client_name: "WUD"
      #   client_secret: "{{ config_authelia_client_secret_wud }}"
      #   # pre_configured_consent_duration: 3M
      #   public: false
      #   authorization_policy: "one_factor"
      #   require_pkce: false
      #   pkce_challenge_method: ""
      #   redirect_uris:
      #     - "https://wud.{{ config_domain_base }}/auth/oidc/authelia/cb"
      #   scopes:
      #     - "openid"
      #     - "email"
      #     - "profile"
      #   response_types:
      #     - "code"
      #   grant_types:
      #     - "authorization_code"
      #   access_token_signed_response_alg: "none"
      #   userinfo_signed_response_alg: "none"
      #   token_endpoint_auth_method: "client_secret_basic"
